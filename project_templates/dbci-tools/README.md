# dbci-tools

Database CI/CD Tools for schema validation, normalization, and migration generation.

## Features

- **BUILD**: Generate HCL schema from SQL files using Atlas
- **LINT**: Validate SQL syntax and style using SQLFluff
- **DIFF**: Generate migration SQL comparing branches using Atlas CLI
- **GUARD**: Prevent destructive changes (table/column drops)
- **Git Integration**: Compare schemas across branches

## Commands

The main CLI provides five commands:

```bash
./run.sh BUILD <project_root>  # Generate HCL schema from db/schema/
./run.sh LINT <project_root>   # Lint SQL files with SQLFluff
./run.sh DIFF <project_root>   # Compare with main branch, generate migration
./run.sh GUARD <project_root>  # Validate no destructive changes
./run.sh ALL <project_root>    # Run all commands in sequence
```

## Tools

### diff.py - Schema Comparison (Atlas-powered)

Generate migration SQL between two schema directories using [Atlas CLI](https://atlasgo.io).

```bash
dbci-diff schema_v1/ schema_v2/ \
    --output migration.sql \
    --schema-analysis \
    --fail-on-drops
```

**Arguments:**

- `dir_a`: First directory (e.g., main branch schema)
- `dir_b`: Second directory (e.g., feature branch schema)
- `--output`: Output file for migration SQL (default: `atlas.migration.sql`)
- `--dev-url`: Atlas dev database URL (default: auto-detect, uses `docker://postgres/15/dev`)
- `--schema-analysis`: Generate detailed report (`.schema-report.md` and `.schema-changes.json`)
- `--fail-on-drops`: Exit with code 1 if tables/columns are dropped

**Benefits over text-based diff:**

- Accurate schema comparison (not affected by whitespace/comments)
- Intelligent migration SQL generation
- Handles column reordering, constraint changes, data types
- PostgreSQL-aware syntax validation

### cli.py - Main Orchestrator

The primary interface for DBCI operations:

- **BUILD**: Generates `target/schema.hcl` from `db/schema/*.sql` using Atlas
- **LINT**: Runs SQLFluff on source SQL files
- **DIFF**: Compares current branch with main, generates migration + reports
- **GUARD**: Validates no destructive DDL changes
- **ALL**: Runs all commands in sequence

### normalizer.py - SQL Formatting (deprecated)

Legacy tool - no longer used in BUILD workflow. SQL files are kept in original format.

### linter.py - SQL Validation

Validate SQL syntax and style using SQLFluff.

```bash
dbci-lint schema/ --dialect postgres --config .sqlfluff
```

### guard.py - DDL Guardrails

Validates schema changes for destructive operations by checking:
1. **Atlas migration changes** (from `target/atlas.migration.schema-changes.json`):
   - Dropped tables
   - Dropped columns
2. **Source SQL patterns**:
   - Raw DROP TABLE/SCHEMA without IF EXISTS
   - CREATE without IF NOT EXISTS

**Important:** GUARD must run **after** DIFF to check the migration JSON file.

```bash
dbci-guard
```

**Exit codes:**
- `0` = All checks passed
- `1` = Destructive changes detected (tables/columns dropped) or unsafe SQL patterns found

### git_normalizer.py - Git Integration

Extract SQL files from specific git branches for comparison.

```bash
dbci-git-normalize /path/to/repo \
    --output /tmp/schema \
    --source db/schema \
    --branch origin/main
```

## Prerequisites

**Required:**

- Python 3.9+
- Atlas CLI: `curl -sSf https://atlasgo.sh | sh`
- SQLFluff: `pip install "sqlfluff>=3.0.0"`
- Docker (for Atlas ephemeral dev databases)

**Optional:**

- Git (for DIFF command to compare branches)

## Environment Variables

- `ATLAS_DEV_URL`: Override default dev database URL
  - Default: `docker://postgres/15/dev?search_path=public` (ephemeral container)
  - Jenkins: `postgres://dev:dev@postgres-dev:5432/dev?search_path=public&sslmode=disable`

## Installation

```bash
pip install -e .
```

This installs the following CLI commands:

- `dbci` - Main orchestrator (BUILD, LINT, DIFF, GUARD, ALL)
- `dbci-diff` - Schema comparison tool
- `dbci-lint` - SQL linter
- `dbci-guard` - Destructive change guard
- `dbci-git-normalize` - Git branch schema extractor
- `dbci-normalize` - SQL formatter (deprecated)

## Project Structure

```
your-db-project/
├── db/
│   └── schema/
│       ├── 001_tables.sql
│       ├── 002_indexes.sql
│       └── ...
├── target/                    # Generated by DBCI
│   ├── schema.hcl            # Current branch HCL
│   ├── main.hcl              # Main branch HCL (baseline)
│   ├── atlas.migration.sql   # Migration SQL
│   ├── atlas.migration.schema-report.md
│   └── atlas.migration.schema-changes.json
└── Jenkinsfile
```

## Output Files

- **target/schema.hcl**: HCL representation of current branch schema
- **target/main.hcl**: HCL representation of main branch schema (for inspection)
- **target/atlas.migration.sql**: Migration SQL to apply changes
- **target/atlas.migration.schema-report.md**: Human-readable change summary
- **target/atlas.migration.schema-changes.json**: Machine-readable change details

## CI/CD Integration

Example Jenkinsfile:

```groovy
pipeline {
    agent any
    
    stages {
        stage('Schema Validation') {
            steps {
                sh '''
                    python3 -m dbci_tools.diff \
                        db/schema/main \
                        db/schema/current \
                        --schema-analysis \
                        --fail-on-drops
                '''
            }
        }
    }
}
```

## Resources

- [Atlas Documentation](https://atlasgo.io/docs)
- [sqlfluff Documentation](https://docs.sqlfluff.com)
- [pgFormatter](https://github.com/darold/pgFormatter)
